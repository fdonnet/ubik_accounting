@using Ubik.Accounting.Contracts.Accounts.Results
@using Ubik.Accounting.Contracts.Currencies.Results
@using Ubik.Accounting.Contracts.Error
@using Ubik.Accounting.Webapp.Shared.Facades
@using Ubik.Accounting.WebApp.Client.Components.Common.Modal
@using Ubik.Accounting.WebApp.Client.Components.Common.Grid
@using Ubik.Accounting.WebApp.Client.Components.Common.Buttons
@using Ubik.Accounting.WebApp.Client.Components.Common.Grid.Columns
@using Ubik.Accounting.WebApp.Client.Components.Common.Grid.Pagination

@inject IAccountingApiClient Client
@inject IRenderContext RenderContext
@attribute [Authorize]

@rendermode InteractiveServer

@if (IsAuthorizedToRead)
{
    @if (IsAuthorizedToModify)
    {
        if (_isLoading || RenderContext.IsPrerendering)
        {
            <button type="button" class="mb-2 text-white bg-blue-400 dark:bg-blue-500 cursor-wait font-medium rounded-lg text-sm px-5 py-2.5 text-center" disabled>Add</button>
        }
        else
        {
            <UbikButton Type="button" Label="Add" AdditionalCssClass="mb-2" OnClick="AddAccountDialogAsync"></UbikButton>
        }

        <CascadingValue Name="AccountModel" Value="@_accountCurrent">
            <UbikModal @ref="_dialog" ButtonLabel="Add" DialogTitle="@_dialogTitle" CloseOnClickOutisde="false">
                <AccountForm CurrenciesList="_currencies" EditMode="@_editMode" OnClose="CloseDialogAsync"></AccountForm>
            </UbikModal>
        </CascadingValue>

        <UbikModalCenter @ref="_deleteDialog">
            <AccountConfirmDelete></AccountConfirmDelete>
        </UbikModalCenter>
    }

    <div class="flex flex-col max-w-max mt-1">
        <div class="relative overflow-x-auto shadow-md sm:rounded-lg">
            <UbikGrid Items="@_accounts" TGridItem="AccountModel" HighlightFirstColumn="true" Pagination="@pagination">
                <UbikColumnProperty Title="Code" Property="@(a=> a.Code)" Sortable="true" IsDefaultSortColumn="true" InitialSortDirection="SortDirection.Ascending"></UbikColumnProperty>
                <UbikColumnProperty Title="Label" Property="@(a=> a.Label)" Sortable="true"></UbikColumnProperty>
                <UbikColumnProperty Title="Domain" Property="@(a=> a.Domain)" Sortable="true"></UbikColumnProperty>
                <UbikColumnProperty Title="Category" Property="@(a=> a.Category)" Sortable="true"></UbikColumnProperty>
                @if (IsAuthorizedToModify)
                {
                    <UbikTemplateColumnTemplateColumn Sortable="false" Title="" SmallXPadding="true">
                        <UbikButtonLink Type="button" Label="Edit" TItem="AccountModel" OnClick="@(()=>EditAccountDialogAsync(context))"></UbikButtonLink>
                    </UbikTemplateColumnTemplateColumn>
                    <UbikTemplateColumnTemplateColumn Sortable="false" Title="" SmallXPadding="true">
                        <UbikButtonLink Type="button" Label="Delete" TItem="AccountModel" OnClick="DeleteConfirmation"></UbikButtonLink>
                    </UbikTemplateColumnTemplateColumn>
                }
            </UbikGrid>
        </div>
        @if (_numberOfAccounts != -1 && _numberOfAccounts > ITEMS_PER_PAGE)
        {
            <div class="mt-3 text-sm">
                <UbikPaginator State="@pagination" />
            </div>
        }
    </div>

}

@*
@if(_error is not null)
{
    @_error
    @_error.Errors[0]
} *@

@code {
    private const int ITEMS_PER_PAGE = 10;
    [Parameter]
    public bool IsAuthorizedToRead { get; set; } = false;
    [Parameter]
    public bool IsAuthorizedToModify { get; set; } = false;

    private IQueryable<AccountModel>? _accounts;
    private int _numberOfAccounts = -1;
    private IEnumerable<GetAllCurrenciesResult>? _currencies;
    private ProblemDetailsContract? _error;

    [CascadingParameter]
    private Task<AuthenticationState>? _authenticationState { get; set; }

    private bool _isLoading = true;
    private UbikModal _dialog = default!;
    private UbikModalCenter _deleteDialog = default!;

    private AccountModel _accountCurrent = new();
    private List<string> _gridAccountFields = new() { "Code", "Label", "Domain", "Category" };

    private bool _editMode = false;
    private string _dialogTitle = "Add account";

    PaginationState pagination = new PaginationState { ItemsPerPage = ITEMS_PER_PAGE };


    protected override async Task OnInitializedAsync()
    {
        if (RenderContext.IsPrerendering)
        {
            return;
        }

        if (_authenticationState is not null)
        {
            await _authenticationState;
            await LoadAccountsAsync();
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await LoadCurrenciesAsync();
        }
    }

    private async Task EditAccountDialogAsync(AccountModel currentAccount)
    {
        _dialogTitle = $"Edit account ({currentAccount.Code})";
        _editMode = true;
        _accountCurrent = currentAccount;
        await _dialog.ShowDialog();
    }

    private async Task AddAccountDialogAsync()
    {
        _dialogTitle = "Add an account";
        _editMode = false;
        _accountCurrent = new();
        await _dialog.ShowDialog();
    }

    private async Task CloseDialogAsync(bool refresh = false)
    {
        if (refresh)
        {
            await LoadAccountsAsync();
        }

        await _dialog.CloseDialogAsync();
    }

    private async Task LoadAccountsAsync()
    {
        _isLoading = true;

        var response = await Client.GetAllAccountsAsync();

        if (response.IsSuccessStatusCode)
        {
            var result = (await response.Content.ReadFromJsonAsync<IEnumerable<GetAllAccountsResult>>() ?? []).ToAccountModel();
            _accounts = result.AsQueryable();
            _numberOfAccounts = _accounts.Count();
        }
        else
        {
            //TODO: IMPLEMENT ERROR HANDLING for PROBLEM DETAILS (and global exception handler)
            //_error = await responseAccountTest.Content.ReadFromJsonAsync<ProblemDetailsContract>();
        }

        _isLoading = false;
    }

    //TODO: see to load that at the correct time to avoid reloading
    private async Task LoadCurrenciesAsync()
    {
        var response = await Client.GetAllCurrenciesAsync();

        if (response.IsSuccessStatusCode)
        {
            _currencies = (await response.Content.ReadFromJsonAsync<IEnumerable<GetAllCurrenciesResult>>() ?? []);
        }
        else
        {
            //TODO: IMPLEMENT ERROR HANDLING for PROBLEM DETAILS (and global exception handler)
            //_error = await responseAccountTest.Content.ReadFromJsonAsync<ProblemDetailsContract>();
        }
    }

    private async Task DeleteConfirmation()
    {
        await _deleteDialog.CloseDialogAsync();
    }
}
